<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <form>
        <label>
            <select class="select">
                <option value="dept">系所</option>
                <option value="stu">學號</option>
            </select>
        </label>
        <label for="input">
        <input type="text" id="input" class="input">
        </label>
        <section class="dept_checked">
            <label for="secno">組別：
                <input type="text" id="secno" class="secno" value="0" placeholder="0">
            </label>
            <label for="grade">年級：
                <input type="text" id="grade" class="grade">
            </label>
            <label for="clacod">班級：
                <input type="text" id="clacod" class="clacod" value="1" placeholder="1">
            </label>
        </section>
        <label for="syearEnd">學年：
            <input type="text" id="syearEnd" class="syearEnd">
        </label>
        <label>
            學期：
            <select class="semEnd">
                <option>1</option>
                <option>2</option>
                <option>3</option>
            </select>
        </label>
        <label>
            顯示排名
            <input type="checkbox" class="Isrank" checked>
        </label>
        <input type="button" value="送出" class="submit">
    </form>
</body>
<script>
    var submit = document.querySelector(".submit");
    var select = document.querySelector(".select");
    var DeptChecked = document.querySelector(".dept_checked");

    select.addEventListener('change', function () {
        DeptChecked.hidden = select.value !== "dept";
    })

    submit.addEventListener('click', function () {

        var input = document.querySelector(".input");
        var secno = document.querySelector(".secno");
        var grade =  document.querySelector(".grade");
        var clacod =  document.querySelector(".clacod");
        var syearEnd = document.querySelector(".syearEnd");
        var semEnd = document.querySelector(".semEnd");
        var Isrank = document.querySelector(".Isrank");
        var json = {};

        if(select.value === "dept"){
            json.DeptId = input.value;
            json.Secno = secno.value;
            json.Grade = grade.value;
            json.Clacod = clacod.value;
            json.StudentId = null;
        }
        else{
            json.DeptId = null;
            json.Secno = 0;
            json.Grade = 0;
            json.Clacod = 0;
            json.StudentId = input.value;
        }
        json.syearEnd = syearEnd.value;
        json.semEnd = semEnd.value;
        json.Isrank = Isrank.checked;

        fetch('http://localhost:44371/api/Calculate',{
            method: 'POST',
            headers: {'Content-type': 'application/json'},
            body: JSON.stringify(json)
        }).then(function (response) {
            console.log(response);
            return fetch('http://localhost:55082/api/generate', {
                method: 'POST',
                headers: { 'Content-type': 'application/json' },
                body: JSON.stringify(json)
            });
        }).then(function (response) {
            var FileNameEncode = response.headers.get('Content-Disposition').split('filename=')[1];
            FileName = decodeURIComponent(FileNameEncode);
            return response.blob();
        }).then(function (blob) {
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = FileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }).catch(function (oError) {
            alert(oError);
        });
    })
</script>
</html>